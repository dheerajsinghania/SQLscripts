CREATE PROCEDURE dbo.sp_FixOrphanedUsers
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @SQL nvarchar(max);
    DECLARE @DBName sysname;
    DECLARE @UserName sysname;
    DECLARE @LoginName sysname;

    -- Cursor to iterate through each user database
    DECLARE db_cursor CURSOR FOR
    SELECT name
    FROM sys.databases
    WHERE database_id > 4 AND state_desc = 'ONLINE';

    OPEN db_cursor;
    FETCH NEXT FROM db_cursor INTO @DBName;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @SQL = '
        USE [' + @DBName + '];

        DECLARE user_cursor CURSOR FOR
        SELECT dp.name AS user_name
        FROM sys.database_principals dp
        LEFT JOIN sys.server_principals sp ON dp.sid = sp.sid
        WHERE dp.type_desc = ''SQL_USER'' AND sp.sid IS NULL;

        OPEN user_cursor;
        FETCH NEXT FROM user_cursor INTO @UserName;

        WHILE @@FETCH_STATUS = 0
        BEGIN
            SET @LoginName = @UserName;
            -- Check if a same-named login exists
            IF EXISTS (SELECT 1 FROM sys.server_principals WHERE name = @LoginName)
            BEGIN
                PRINT ''Fixing orphaned user ' + @UserName + ' in database ' + @DBName + '...'';
                -- Remap the user to the existing login
                ALTER USER [' + @UserName + '] WITH LOGIN = [' + @LoginName + '];
            END
            ELSE
            BEGIN
                PRINT ''Could not fix user ' + @UserName + ' in database ' + @DBName + ' (Login not found). '';
            END

            FETCH NEXT FROM user_cursor INTO @UserName;
        END

        CLOSE user_cursor;
        DEALLOCATE user_cursor;
        ';

        EXEC sp_executesql @SQL;

        FETCH NEXT FROM db_cursor INTO @DBName;
    END

    CLOSE db_cursor;
    DEALLOCATE db_cursor;

END
GO
