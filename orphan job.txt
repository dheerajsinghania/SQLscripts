DECLARE @dbName NVARCHAR (128);
DECLARE @sql NVARCHAR(MAX);
DECLARE db_cursor CURSOR FOR 
SELECT name FROM sys.databases
WHERE database_id > 4 -- Exclude system databases
AND state_desc = 'ONLINE';
OPEN db_cursor;
FETCH NEXT FROM db_cursor INTO @dbName;
WHILE @@FETCH STATUS = 0
BEGIN
PRINT 'Checking database: ' + @dbname;
SET @sql = '
USE [' + @dbName + '];
DECLARE @userName NVARCHAR (128):

DECLARE orphaned_users CURSOR FOR 
Select dp.name
From sys.database_principals dp
LEFT JOIN sys.server_principals SP ON dp.sid = Sp.sid
WHERE dp.type IN (''S'',''U'') AND Sp.sid IS NULL AND dp.authentication_type = 1;

OPEN orphaned_users;
FETCH NEXT FROM orphaned_users INTO @userName;

WHILE @@FETCH_STATUS =0
BEGIN
BEGIN TRY
PRINT '' - Fixing orphaned user: '' + @username;
EXEC(''ALTER USER ['' + @userName + ''] WITH LOGIN = ['' + @userName + '']'');
END TRY
BEGIN CATCH
PRINT '' - Failed to fix user: '' + @userName + ''. Error: '' +ERROR_MESSAGE() ;
END CATCH;

FETCH NEXT FROM orphaned_users INTO @userName;
END
CLOSE orphaned_users;
DEALLOCATE orphaned_users;
';
EXEC sp_executesql @sql;

FETCH NEXT FROM db_cursor INTO @dbName;
END
CLOSE db_cursor;
DEALLOCATE db_cursor;
PRINT 'Orphaned user fix completed for allÂ databases.';